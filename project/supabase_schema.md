# Supabase Database Schema - Offer Testing System

## Entity Relationship Overview

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   OFFERS    │     │  COMPANIES  │     │  CONTACTS   │
│             │     │             │     │             │
│ id          │◄────│ offer_id    │     │ company_id  │───►│
│ name        │     │ id          │◄────│ id          │
│ description │     │ name        │     │ name        │
│ icp         │     │ url         │     │ email       │
│ status      │     │ signals     │     │ linkedin    │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────┐
│                     CAMPAIGNS                        │
│                                                      │
│ id, offer_id, name, status, channel                 │
└─────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────┐
│                 CAMPAIGN_CONTACTS                    │
│                                                      │
│ campaign_id, contact_id, status, messages           │
└─────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────┐
│                    MESSAGES                          │
│                                                      │
│ id, campaign_contact_id, account_id, content        │
└─────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐
│  ACCOUNTS   │     │   TOOLS     │
│             │     │             │
│ LinkedIn    │     │ Parallel    │
│ Email       │     │ Unipile     │
│ limits      │     │ Leadmagic   │
└─────────────┘     └─────────────┘
```

---

## Table Definitions

### 1. OFFERS
The products/services we're testing. Can be internal or for clients.

```sql
CREATE TABLE offers (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    slug TEXT UNIQUE,  -- URL-friendly identifier
    
    -- Classification
    type TEXT NOT NULL CHECK (type IN ('product', 'service')),
    ownership TEXT NOT NULL CHECK (ownership IN ('internal', 'client')),
    client_name TEXT,  -- If ownership = 'client'
    
    -- Offer Details
    description TEXT NOT NULL,
    problem_solved TEXT,
    value_proposition TEXT,
    price_range TEXT,  -- 'low', 'mid', 'high', 'enterprise'
    
    -- Complete Positioning Canvas (AUTO-GENERATED by /new-offer)
    positioning JSONB,
    /*
    {
        "category": {
            "name": "AI Sales Coach",
            "competing_with": "Sales Training Platforms",
            "differentiator": "Real-time AI practice vs recorded videos"
        },
        "problem": {
            "core_problem": "New sales reps take 6+ months to hit quota",
            "who_feels_it": ["VP Sales", "Sales Managers"],
            "business_impact": "Longer ramp time, missed revenue",
            "customer_language": "Our reps aren't ready for live calls",
            "awareness_level": "pain_point"
        },
        "symptoms": [
            {
                "type": "hiring",
                "signal": "Posting SDR/BDR jobs",
                "detection": "TheirStack",
                "filter": "last_30_days",
                "reasoning": "Growing teams need training",
                "score": {"detectable": 5, "relevant": 5, "timely": 5, "specific": 5, "total": 20}
            }
        ],
        "outcomes": {
            "immediate": "Reps practice without manager time",
            "short_term": "Cut ramp time 50%",
            "long_term": "$150K+ revenue per rep faster",
            "emotional": "Confidence before first call"
        },
        "alternatives": [
            {
                "name": "Status quo (shadow senior reps)",
                "cons": "Doesn't scale, inconsistent"
            }
        ],
        "positioning_statement": "We help B2B SaaS sales teams cut ramp time in half...",
        "signal_stacks": [
            {
                "name": "Rapid Scaling Stack",
                "signals": ["Series A/B funding", "Hiring 3+ sales roles"],
                "story": "Growing fast, training is falling on managers",
                "priority": "high",
                "expected_reply_rate": "15-25%"
            }
        ],
        "disqualifying_signals": [
            "Too small (< 10 employees)",
            "Enterprise (1000+ employees)"
        ]
    }
    */
    
    -- Generated ICP (derived from positioning)
    icp JSONB,
    /*
    {
        "company": {
            "verticals": ["saas", "fintech"],
            "size_min": 20,
            "size_max": 200,
            "signals": ["hiring_sales", "using_crm"],
            "disqualifiers": ["enterprise_only", "no_sales_team"]
        },
        "buyer": {
            "titles": ["VP Sales", "Head of Sales", "Sales Director"],
            "departments": ["Sales", "Revenue"],
            "seniority": ["Director", "VP", "C-Level"]
        }
    }
    */
    
    -- Generated Copy Templates
    email_templates JSONB,
    /*
    {
        "sequence": [
            {"step": 1, "subject": "...", "body": "...", "delay_days": 0},
            {"step": 2, "subject": "...", "body": "...", "delay_days": 3},
            {"step": 3, "subject": "...", "body": "...", "delay_days": 5}
        ]
    }
    */
    linkedin_templates JSONB,
    /*
    {
        "connection_request": "...",
        "follow_up_dm": "...",
        "inmail": "..."
    }
    */
    
    -- Status
    status TEXT DEFAULT 'draft' CHECK (status IN (
        'draft',      -- Still being defined
        'ready',      -- ICP and copy ready
        'active',     -- Campaigns running
        'paused',     -- Temporarily stopped
        'completed',  -- Done testing
        'killed'      -- Didn't work, archived
    )),
    
    -- Metrics (denormalized for quick access)
    total_companies INTEGER DEFAULT 0,
    total_contacts INTEGER DEFAULT 0,
    total_sent INTEGER DEFAULT 0,
    total_replies INTEGER DEFAULT 0,
    total_meetings INTEGER DEFAULT 0,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for common queries
CREATE INDEX idx_offers_status ON offers(status);
CREATE INDEX idx_offers_type ON offers(type);

-- Index for querying positioning (GIN index for JSONB)
CREATE INDEX idx_offers_positioning_category ON offers USING GIN ((positioning -> 'category'));
CREATE INDEX idx_offers_positioning_problem ON offers USING GIN ((positioning -> 'problem'));
```

---

### 2. COMPANIES
Companies discovered for each offer.

```sql
CREATE TABLE companies (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Relationships
    offer_id UUID NOT NULL REFERENCES offers(id) ON DELETE CASCADE,
    
    -- Company Info
    name TEXT NOT NULL,
    domain TEXT,  -- example.com (normalized, no www)
    url TEXT,     -- Full URL
    description TEXT,
    
    -- Firmographics
    size TEXT CHECK (size IN ('1-10', '11-50', '51-200', '201-500', '501-1000', '1000+')),
    size_exact INTEGER,  -- If we have exact number
    vertical TEXT,
    industry TEXT,
    
    -- Location
    headquarters_city TEXT,
    headquarters_state TEXT,
    headquarters_country TEXT,
    
    -- Signals (what we found about them)
    signals JSONB DEFAULT '{}',
    /*
    {
        "hiring": {
            "sales_reps": 5,
            "bdrs": 2,
            "last_checked": "2024-01-15"
        },
        "tech_stack": ["salesforce", "hubspot", "gong"],
        "funding": {
            "stage": "series_b",
            "amount": 25000000,
            "date": "2023-06-01"
        },
        "growth_signals": ["new_office", "leadership_hire"]
    }
    */
    
    -- Scoring
    fit_score INTEGER CHECK (fit_score >= 1 AND fit_score <= 10),
    fit_reasoning TEXT,
    priority TEXT CHECK (priority IN ('high', 'medium', 'low')),
    
    -- Source Tracking
    source_tool TEXT NOT NULL,  -- 'parallel', 'theirstack', 'exa', 'manual'
    source_query TEXT,  -- The query that found this company
    source_raw JSONB,   -- Raw API response
    
    -- Status
    status TEXT DEFAULT 'new' CHECK (status IN (
        'new',           -- Just discovered
        'qualified',     -- Passed ICP check
        'disqualified',  -- Doesn't fit
        'contacted',     -- Have reached out
        'responded',     -- Got a response
        'meeting',       -- Meeting scheduled
        'converted',     -- Became customer
        'rejected'       -- Said no
    )),
    disqualification_reason TEXT,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Prevent duplicates per offer
    UNIQUE(offer_id, domain)
);

-- Indexes
CREATE INDEX idx_companies_offer ON companies(offer_id);
CREATE INDEX idx_companies_status ON companies(status);
CREATE INDEX idx_companies_source ON companies(source_tool);
CREATE INDEX idx_companies_fit_score ON companies(fit_score DESC);
```

---

### 3. CONTACTS
People at companies.

```sql
CREATE TABLE contacts (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Relationships
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    offer_id UUID NOT NULL REFERENCES offers(id) ON DELETE CASCADE,
    
    -- Person Info
    first_name TEXT,
    last_name TEXT,
    full_name TEXT,
    
    -- Professional
    title TEXT,
    title_normalized TEXT,  -- 'vp_sales', 'director_sales', etc.
    department TEXT,
    seniority TEXT CHECK (seniority IN ('c_level', 'vp', 'director', 'manager', 'individual')),
    
    -- Contact Methods
    email TEXT,
    email_status TEXT CHECK (email_status IN (
        'unknown',    -- Haven't verified
        'valid',      -- Verified deliverable
        'invalid',    -- Bounced or catch-all
        'risky',      -- Might bounce
        'failed'      -- Enrichment failed
    )),
    email_verification_source TEXT, -- 'leadmagic', 'fullenrich', etc.
    email_verified BOOLEAN GENERATED ALWAYS AS (email_status = 'valid') STORED,
    phone TEXT,
    
    -- LinkedIn
    linkedin_url TEXT,
    linkedin_id TEXT,  -- LinkedIn's internal ID if available
    connection_degree INTEGER CHECK (connection_degree IN (1, 2, 3)),
    
    -- Relationship Status (per-offer)
    already_contacted BOOLEAN DEFAULT FALSE,
    last_contacted_at TIMESTAMPTZ,
    contact_count INTEGER DEFAULT 0,  -- How many times we've reached out

    -- Global outreach tracking (cross-offer)
    global_last_contacted_at TIMESTAMPTZ,
    global_contact_count INTEGER DEFAULT 0,
    global_last_reply_at TIMESTAMPTZ,
    global_status TEXT DEFAULT 'available' CHECK (global_status IN (
        'available', 'cooling_off', 'do_not_contact', 'replied'
    )),
    eligible_for_outreach BOOLEAN DEFAULT TRUE,
    
    -- Scoring
    buyer_fit_score INTEGER CHECK (buyer_fit_score >= 1 AND buyer_fit_score <= 10),
    priority TEXT CHECK (priority IN ('high', 'medium', 'low')),
    
    -- Source Tracking
    source_tool TEXT NOT NULL,  -- 'parallel', 'leadmagic', 'linkedin', 'manual'
    source_raw JSONB,
    
    -- Status
    status TEXT DEFAULT 'new' CHECK (status IN (
        'new',           -- Just discovered
        'enriched',      -- Got email/phone
        'ready',         -- Ready for outreach
        'skip',          -- Skip (1st degree, already contacted, etc.)
        'queued',        -- In outreach queue
        'contacted',     -- Reached out
        'replied',       -- Got response
        'meeting',       -- Meeting scheduled
        'converted',     -- Became customer
        'unsubscribed',  -- Opted out
        'bounced'        -- Email bounced
    )),
    skip_reason TEXT,  -- '1st_degree', 'already_contacted', 'no_email', etc.
    
    -- Notes
    notes TEXT,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Prevent duplicates
    UNIQUE(offer_id, linkedin_url),
    UNIQUE(offer_id, email)
);

-- Indexes
CREATE INDEX idx_contacts_company ON contacts(company_id);
CREATE INDEX idx_contacts_offer ON contacts(offer_id);
CREATE INDEX idx_contacts_status ON contacts(status);
CREATE INDEX idx_contacts_email ON contacts(email) WHERE email IS NOT NULL;
CREATE INDEX idx_contacts_linkedin ON contacts(linkedin_url) WHERE linkedin_url IS NOT NULL;
CREATE INDEX idx_contacts_global_status ON contacts(global_status);
CREATE INDEX idx_contacts_global_last_contacted ON contacts(global_last_contacted_at);
CREATE INDEX idx_contacts_eligible ON contacts(eligible_for_outreach) WHERE eligible_for_outreach = TRUE;
```

---

### 4. CAMPAIGNS
Outreach campaigns linking offers to contacts.

```sql
CREATE TABLE campaigns (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    
    -- Relationships
    offer_id UUID NOT NULL REFERENCES offers(id) ON DELETE CASCADE,
    
    -- Campaign Configuration
    channel TEXT NOT NULL CHECK (channel IN ('email', 'linkedin', 'multi')),
    campaign_type TEXT DEFAULT 'cold_outreach' CHECK (campaign_type IN ('networking', 'cold_outreach')),
    account_id UUID REFERENCES accounts(id),  -- Primary account to send from (for single-channel campaigns)
    
    -- Campaign Metadata (REQUIRED for all campaigns)
    campaign_slug TEXT UNIQUE,  -- Structured slug: {type}-{offer}-{channel}-{signal}-{icp}-{account}
    account_ids JSONB,  -- Array of account IDs and names: [{"id": "...", "name": "...", "type": "email|linkedin"}, ...]
    
    -- Targeting
    target_criteria JSONB,
    /*
    {
        "company_status": ["qualified"],
        "contact_status": ["ready", "enriched"],
        "min_fit_score": 7,
        "connection_degrees": [2, 3],
        "exclude_1st_degree": true,
        "signal": "hiring",  -- Primary signal being targeted
        "icp_target": "pmre-companies",  -- Specific ICP segment
        "signals": [  -- Detailed signal definitions
            {
                "type": "HIRING",
                "description": "Hiring 2+ sales roles",
                "priority": "HIGH"
            }
        ]
    }
    */
    
    -- Sequence Configuration
    sequence_config JSONB,

    -- Scheduling Configuration (per-campaign)
    scheduling_config JSONB,
    /*
    {
        "steps": [
            {"step": 1, "type": "connection_request", "delay_days": 0},
            {"step": 2, "type": "linkedin_dm", "delay_days": 3, "condition": "connected"},
            {"step": 3, "type": "email", "delay_days": 5, "condition": "no_reply"}
        ],
        "stop_on_reply": true,
        "max_touches": 3
    }
    */
    
    -- Status
    status TEXT DEFAULT 'draft' CHECK (status IN (
        'draft',      -- Being configured
        'ready',      -- Ready to launch
        'active',     -- Currently running
        'paused',     -- Temporarily stopped
        'completed',  -- Finished
        'cancelled'   -- Stopped permanently
    )),
    
    -- Timing
    send_window_start TIME DEFAULT '09:00',
    send_window_end TIME DEFAULT '17:00',
    send_days INTEGER[] DEFAULT ARRAY[1,2,3,4,5],  -- Mon-Fri (1=Monday)
    timezone TEXT DEFAULT 'America/New_York',
    
    -- Progress
    total_contacts INTEGER DEFAULT 0,
    contacts_sent INTEGER DEFAULT 0,
    contacts_remaining INTEGER DEFAULT 0,
    
    -- Metrics (denormalized)
    total_sent INTEGER DEFAULT 0,
    total_delivered INTEGER DEFAULT 0,
    total_opened INTEGER DEFAULT 0,
    total_clicked INTEGER DEFAULT 0,
    total_replied INTEGER DEFAULT 0,
    total_positive_replies INTEGER DEFAULT 0,
    total_meetings INTEGER DEFAULT 0,
    
    -- Rates (calculated)
    open_rate DECIMAL(5,2),
    reply_rate DECIMAL(5,2),
    positive_reply_rate DECIMAL(5,2),
    meeting_rate DECIMAL(5,2),
    
    -- Timestamps
    first_send_at TIMESTAMPTZ,
    last_send_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_campaigns_offer ON campaigns(offer_id);
CREATE INDEX idx_campaigns_status ON campaigns(status);
CREATE INDEX idx_campaigns_account ON campaigns(account_id);
CREATE INDEX idx_campaigns_slug ON campaigns(campaign_slug);
```

**Migration Required:** Run `scripts/apply-campaign-columns.sql` to add `campaign_slug`, `account_ids`, and `target_criteria` to existing databases.

---

### 5. CAMPAIGN_CONTACTS
Junction table linking campaigns to contacts with status.

```sql
CREATE TABLE campaign_contacts (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Relationships
    campaign_id UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
    contact_id UUID NOT NULL REFERENCES contacts(id) ON DELETE CASCADE,
    
    -- Sequence Progress
    current_step INTEGER DEFAULT 0,
    max_step INTEGER,
    
    -- Status
    status TEXT DEFAULT 'queued' CHECK (status IN (
        'queued',         -- Waiting to start
        'in_progress',    -- Sequence running
        'waiting',        -- Waiting for next step (delay)
        'paused',         -- Manually paused
        'completed',      -- Finished sequence
        'replied',        -- Got a reply (stopped)
        'meeting',        -- Meeting booked
        'bounced',        -- Email bounced
        'unsubscribed',   -- Opted out
        'failed'          -- Send failed
    )),
    
    -- Engagement
    opened BOOLEAN DEFAULT FALSE,
    clicked BOOLEAN DEFAULT FALSE,
    replied BOOLEAN DEFAULT FALSE,
    reply_sentiment TEXT CHECK (reply_sentiment IN ('positive', 'negative', 'neutral', 'question', 'ooo')),
    meeting_booked BOOLEAN DEFAULT FALSE,
    
    -- Timing
    added_at TIMESTAMPTZ DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    next_step_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    
    -- Prevent duplicates
    UNIQUE(campaign_id, contact_id)
);

-- Indexes
CREATE INDEX idx_campaign_contacts_campaign ON campaign_contacts(campaign_id);
CREATE INDEX idx_campaign_contacts_contact ON campaign_contacts(contact_id);
CREATE INDEX idx_campaign_contacts_status ON campaign_contacts(status);
CREATE INDEX idx_campaign_contacts_next_step ON campaign_contacts(next_step_at) 
    WHERE status IN ('queued', 'in_progress', 'waiting');
```

---

### 6. MESSAGES
Individual messages sent.

```sql
CREATE TABLE messages (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Relationships
    campaign_contact_id UUID NOT NULL REFERENCES campaign_contacts(id) ON DELETE CASCADE,
    campaign_id UUID REFERENCES campaigns(id) ON DELETE CASCADE,
    contact_id UUID NOT NULL REFERENCES contacts(id) ON DELETE CASCADE,
    account_id UUID NOT NULL REFERENCES accounts(id),
    send_queue_id UUID REFERENCES send_queue(id) ON DELETE SET NULL,
    
    -- Message Details
    channel TEXT NOT NULL CHECK (channel IN (
        'email',
        'linkedin_connect',
        'linkedin_dm',
        'linkedin_inmail'
    )),
    action_type TEXT CHECK (action_type IN (
        'connection_request',
        'message',
        'email',
        'inmail'
    )),
    sequence_step INTEGER NOT NULL,
    
    -- Content
    subject TEXT,  -- For email
    body TEXT NOT NULL,
    personalization_used JSONB,  -- Variables that were substituted
    
    -- External IDs
    external_id TEXT,  -- ID from Unipile/email provider
    thread_id TEXT,    -- For email threads
    
    -- Status
    status TEXT DEFAULT 'pending' CHECK (status IN (
        'pending',     -- Not yet sent
        'queued',      -- In send queue
        'sending',     -- Currently sending
        'sent',        -- Successfully sent
        'delivered',   -- Confirmed delivered
        'opened',      -- Opened (email)
        'clicked',     -- Link clicked
        'replied',     -- Got a reply
        'bounced',     -- Bounced
        'failed'       -- Failed to send
    )),
    error_message TEXT,
    
    -- Engagement
    opened_at TIMESTAMPTZ,
    clicked_at TIMESTAMPTZ,
    replied_at TIMESTAMPTZ,
    
    -- Reply Details
    reply_text TEXT,
    reply_sentiment TEXT CHECK (reply_sentiment IN ('positive', 'negative', 'neutral', 'question', 'ooo')),
    
    -- Timestamps
    scheduled_at TIMESTAMPTZ,
    sent_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_messages_campaign_contact ON messages(campaign_contact_id);
CREATE INDEX idx_messages_campaign ON messages(campaign_id);
CREATE INDEX idx_messages_contact ON messages(contact_id);
CREATE INDEX idx_messages_account ON messages(account_id);
CREATE INDEX idx_messages_send_queue ON messages(send_queue_id);
CREATE INDEX idx_messages_status ON messages(status);
CREATE INDEX idx_messages_scheduled ON messages(scheduled_at) WHERE status = 'pending';
```

**Note:** `messages` stores the content + intent (what we plan to send).  
Actual sending is driven by `send_queue`.

---

### 7. ACCOUNTS
LinkedIn and email accounts used for sending.

```sql
CREATE TABLE accounts (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,  -- 'mike_linkedin', 'eugene_linkedin', 'sales@company.com'
    
    -- Account Type
    type TEXT NOT NULL CHECK (type IN ('linkedin', 'email')),
    owner TEXT NOT NULL,  -- 'mike', 'eugene'
    
    -- Connection Details
    email_address TEXT,
    linkedin_url TEXT,
    
    -- Integration
    unipile_account_id TEXT,  -- ID in Unipile
    provider TEXT,  -- 'gmail', 'outlook', 'linkedin'
    rotation_set TEXT CHECK (rotation_set IN ('odd', 'even', 'burner')),
    
    -- Status
    status TEXT DEFAULT 'active' CHECK (status IN (
        'active',       -- Working
        'warming',      -- Warming up (new account)
        'paused',       -- Temporarily paused
        'limited',      -- Hit limits, waiting
        'disconnected', -- Lost connection
        'banned'        -- Account restricted
    )),
    
    -- Limits
    daily_limit_connections INTEGER DEFAULT 20,
    daily_limit_messages INTEGER DEFAULT 40,
    daily_limit_emails INTEGER DEFAULT 100,
    hourly_limit INTEGER DEFAULT 10,
    
    -- Warming Schedule (for new accounts)
    warming_week INTEGER DEFAULT 0,  -- 0 = not warming, 1-4 = warming weeks
    warming_started_at TIMESTAMPTZ,
    
    -- Today's Activity (reset daily)
    today_connections INTEGER DEFAULT 0,
    today_messages INTEGER DEFAULT 0,
    today_emails INTEGER DEFAULT 0,
    today_last_action_at TIMESTAMPTZ,
    
    -- Lifetime Stats
    total_sent INTEGER DEFAULT 0,
    total_delivered INTEGER DEFAULT 0,
    total_bounced INTEGER DEFAULT 0,
    total_replies INTEGER DEFAULT 0,
    
    -- Health Metrics
    health_score INTEGER DEFAULT 100,
    bounce_rate DECIMAL(5,2),
    spam_rate DECIMAL(5,2),
    reply_rate DECIMAL(5,2),
    last_health_check TIMESTAMPTZ,
    
    -- Timestamps
    connected_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_accounts_type ON accounts(type);
CREATE INDEX idx_accounts_owner ON accounts(owner);
CREATE INDEX idx_accounts_status ON accounts(status);
```

---

### 8. ACCOUNT_ACTIVITY
Detailed activity log for rate limiting and debugging.

```sql
CREATE TABLE account_activity (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Relationships
    account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
    message_id UUID REFERENCES messages(id),
    contact_id UUID REFERENCES contacts(id),
    
    -- Activity Details
    action_type TEXT NOT NULL CHECK (action_type IN (
        'connection_request',
        'message',
        'email',
        'inmail',
        'profile_view'
    )),
    
    -- Status
    status TEXT NOT NULL CHECK (status IN ('success', 'failed', 'rate_limited')),
    error_message TEXT,
    
    -- Timing
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for rate limit queries
CREATE INDEX idx_activity_account_date ON account_activity(account_id, created_at);
CREATE INDEX idx_activity_daily ON account_activity(account_id, action_type, created_at)
    WHERE created_at >= CURRENT_DATE;
```

---

### 9. TOOLS
External tools/APIs used for enrichment.

```sql
CREATE TABLE tools (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL UNIQUE,  -- 'parallel', 'unipile', 'leadmagic', etc.
    
    -- Type
    type TEXT NOT NULL CHECK (type IN (
        'company_search',    -- Find companies
        'people_search',     -- Find people
        'enrichment',        -- Enrich data
        'email_finding',     -- Find emails
        'email_verification', -- Verify emails
        'sending',           -- Send messages
        'inbox'              -- Read inbox
    )),
    
    -- API Configuration
    api_base_url TEXT,
    api_docs_url TEXT,
    
    -- Status
    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'error')),
    last_error TEXT,
    last_success_at TIMESTAMPTZ,
    last_error_at TIMESTAMPTZ,
    
    -- Usage Tracking
    total_requests INTEGER DEFAULT 0,
    total_credits_used INTEGER DEFAULT 0,
    credits_remaining INTEGER,
    credits_reset_at TIMESTAMPTZ,
    
    -- Rate Limits
    rate_limit_per_minute INTEGER,
    rate_limit_per_day INTEGER,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Pre-populate with our tools
INSERT INTO tools (name, type, api_docs_url) VALUES
    ('parallel_companies', 'company_search', 'https://docs.parallel.ai/'),
    ('parallel_people', 'people_search', 'https://docs.parallel.ai/'),
    ('theirstack', 'company_search', 'https://theirstack.com/docs'),
    ('exa', 'company_search', 'https://docs.exa.ai/'),
    ('sumble', 'enrichment', 'https://docs.sumble.com/'),
    ('leadmagic', 'email_finding', 'https://docs.leadmagic.io/'),
    ('firecrawl', 'enrichment', 'https://docs.firecrawl.dev/'),
    ('unipile', 'sending', 'https://docs.unipile.com/'),
    ('unipile', 'inbox', 'https://docs.unipile.com/');
```

---

### 10. TOOL_USAGE
Log of API calls to external tools.

```sql
CREATE TABLE tool_usage (
    -- Identity
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Relationships
    tool_id UUID NOT NULL REFERENCES tools(id),
    offer_id UUID REFERENCES offers(id),
    company_id UUID REFERENCES companies(id),
    contact_id UUID REFERENCES contacts(id),
    
    -- Request Details
    action TEXT NOT NULL,  -- 'search', 'enrich', 'verify', etc.
    request_params JSONB,
    
    -- Response
    status TEXT NOT NULL CHECK (status IN ('success', 'error', 'rate_limited')),
    response_summary JSONB,  -- Summarized result (not full response)
    results_count INTEGER,
    error_message TEXT,
    
    -- Costs
    credits_used INTEGER DEFAULT 0,
    
    -- Timing
    duration_ms INTEGER,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_tool_usage_tool ON tool_usage(tool_id);
CREATE INDEX idx_tool_usage_date ON tool_usage(created_at);
```

---

## Views for Common Queries

```sql
-- Offer Dashboard
CREATE VIEW offer_dashboard AS
SELECT 
    o.*,
    COUNT(DISTINCT c.id) as company_count,
    COUNT(DISTINCT co.id) as contact_count,
    COUNT(DISTINCT ca.id) as campaign_count,
    COALESCE(SUM(ca.total_sent), 0) as total_sent,
    COALESCE(SUM(ca.total_replied), 0) as total_replies,
    COALESCE(SUM(ca.total_meetings), 0) as total_meetings
FROM offers o
LEFT JOIN companies c ON c.offer_id = o.id
LEFT JOIN contacts co ON co.offer_id = o.id
LEFT JOIN campaigns ca ON ca.offer_id = o.id
GROUP BY o.id;

-- Contacts Ready for Outreach
CREATE VIEW contacts_ready AS
SELECT 
    co.*,
    c.name as company_name,
    c.domain as company_domain,
    c.fit_score as company_fit_score,
    o.name as offer_name
FROM contacts co
JOIN companies c ON co.company_id = c.id
JOIN offers o ON co.offer_id = o.id
WHERE co.status IN ('ready', 'enriched')
AND co.skip_reason IS NULL
AND (co.connection_degree IS NULL OR co.connection_degree > 1)
AND co.already_contacted = FALSE;

-- Account Health
CREATE VIEW account_health AS
SELECT 
    a.*,
    a.daily_limit_connections - a.today_connections as connections_remaining,
    a.daily_limit_messages - a.today_messages as messages_remaining,
    a.daily_limit_emails - a.today_emails as emails_remaining,
    CASE 
        WHEN a.status = 'active' 
            AND a.today_connections < a.daily_limit_connections 
            AND a.today_messages < a.daily_limit_messages 
        THEN TRUE 
        ELSE FALSE 
    END as can_send
FROM accounts a;

-- Campaign Performance
CREATE VIEW campaign_performance AS
SELECT 
    c.*,
    o.name as offer_name,
    ROUND(c.total_replied::decimal / NULLIF(c.total_sent, 0) * 100, 2) as reply_rate,
    ROUND(c.total_positive_replies::decimal / NULLIF(c.total_replied, 0) * 100, 2) as positive_rate,
    ROUND(c.total_meetings::decimal / NULLIF(c.total_sent, 0) * 100, 2) as meeting_rate
FROM campaigns c
JOIN offers o ON c.offer_id = o.id;

-- Today's Send Queue
CREATE VIEW todays_queue AS
SELECT 
    m.*,
    co.full_name as contact_name,
    co.email as contact_email,
    co.linkedin_url as contact_linkedin,
    c.name as company_name,
    a.name as account_name,
    a.status as account_status,
    (SELECT can_send FROM account_health ah WHERE ah.id = m.account_id) as account_can_send
FROM messages m
JOIN campaign_contacts cc ON m.campaign_contact_id = cc.id
JOIN contacts co ON m.contact_id = co.id
JOIN companies c ON co.company_id = c.id
JOIN accounts a ON m.account_id = a.id
WHERE m.status = 'pending'
AND (m.scheduled_at IS NULL OR m.scheduled_at <= NOW())
ORDER BY m.scheduled_at ASC;
```

---

## Functions

```sql
-- Reset daily counters (run via cron at midnight)
CREATE OR REPLACE FUNCTION reset_daily_counters()
RETURNS void AS $$
BEGIN
    UPDATE accounts
    SET 
        today_connections = 0,
        today_messages = 0,
        today_emails = 0,
        updated_at = NOW();
END;
$$ LANGUAGE plpgsql;

-- Check if account can send
CREATE OR REPLACE FUNCTION can_account_send(
    p_account_id UUID,
    p_action_type TEXT
) RETURNS BOOLEAN AS $$
DECLARE
    v_account accounts%ROWTYPE;
    v_within_hours BOOLEAN;
BEGIN
    SELECT * INTO v_account FROM accounts WHERE id = p_account_id;
    
    -- Check account status
    IF v_account.status != 'active' THEN
        RETURN FALSE;
    END IF;
    
    -- Check limits
    IF p_action_type = 'connection_request' 
       AND v_account.today_connections >= v_account.daily_limit_connections THEN
        RETURN FALSE;
    END IF;
    
    IF p_action_type = 'message' 
       AND v_account.today_messages >= v_account.daily_limit_messages THEN
        RETURN FALSE;
    END IF;
    
    IF p_action_type = 'email' 
       AND v_account.today_emails >= v_account.daily_limit_emails THEN
        RETURN FALSE;
    END IF;
    
    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;

-- Increment account counter
CREATE OR REPLACE FUNCTION increment_account_counter(
    p_account_id UUID,
    p_action_type TEXT
) RETURNS void AS $$
BEGIN
    UPDATE accounts
    SET 
        today_connections = CASE WHEN p_action_type = 'connection_request' 
                                 THEN today_connections + 1 ELSE today_connections END,
        today_messages = CASE WHEN p_action_type = 'message' 
                              THEN today_messages + 1 ELSE today_messages END,
        today_emails = CASE WHEN p_action_type = 'email' 
                            THEN today_emails + 1 ELSE today_emails END,
        today_last_action_at = NOW(),
        total_sent = total_sent + 1,
        updated_at = NOW()
    WHERE id = p_account_id;
END;
$$ LANGUAGE plpgsql;

-- Update campaign metrics
CREATE OR REPLACE FUNCTION update_campaign_metrics(p_campaign_id UUID)
RETURNS void AS $$
BEGIN
    UPDATE campaigns c
    SET 
        total_contacts = (SELECT COUNT(*) FROM campaign_contacts WHERE campaign_id = p_campaign_id),
        contacts_sent = (SELECT COUNT(*) FROM campaign_contacts WHERE campaign_id = p_campaign_id AND status != 'queued'),
        contacts_remaining = (SELECT COUNT(*) FROM campaign_contacts WHERE campaign_id = p_campaign_id AND status IN ('queued', 'waiting')),
        total_sent = (SELECT COUNT(*) FROM messages m JOIN campaign_contacts cc ON m.campaign_contact_id = cc.id WHERE cc.campaign_id = p_campaign_id AND m.status = 'sent'),
        total_replied = (SELECT COUNT(*) FROM campaign_contacts WHERE campaign_id = p_campaign_id AND replied = TRUE),
        total_meetings = (SELECT COUNT(*) FROM campaign_contacts WHERE campaign_id = p_campaign_id AND meeting_booked = TRUE),
        reply_rate = ROUND((SELECT COUNT(*)::decimal FROM campaign_contacts WHERE campaign_id = p_campaign_id AND replied = TRUE) / 
                          NULLIF((SELECT COUNT(*) FROM campaign_contacts WHERE campaign_id = p_campaign_id AND status NOT IN ('queued')), 0) * 100, 2),
        updated_at = NOW()
    WHERE id = p_campaign_id;
END;
$$ LANGUAGE plpgsql;
```

---

## Relationship Summary

```
OFFERS (1) ───────────────────────────────── (N) COMPANIES
   │                                              │
   │                                              │
   │ (1)                                     (N)  │
   │                                              │
   └──────────────────── (N) CONTACTS ────────────┘
                              │
                              │ (N)
                              │
                         CAMPAIGNS (1) ─── (1) ACCOUNTS
                              │
                              │ (N)
                              │
                      CAMPAIGN_CONTACTS
                              │
                              │ (N)
                              │
                          MESSAGES ─────── (1) ACCOUNTS
                              
TOOLS (1) ──────────────────── (N) TOOL_USAGE

ACCOUNTS (1) ───────────────── (N) ACCOUNT_ACTIVITY
```

---

## Key Queries

```sql
-- Get all contacts ready to outreach for an offer
SELECT * FROM contacts_ready WHERE offer_id = 'xxx';

-- Get account status with remaining limits
SELECT * FROM account_health;

-- Get campaign performance
SELECT * FROM campaign_performance WHERE offer_id = 'xxx';

-- Get today's send queue
SELECT * FROM todays_schedule LIMIT 20;

-- Check if we've contacted this person before (across all offers)
SELECT * FROM contacts 
WHERE linkedin_url = 'https://linkedin.com/in/xxx'
AND already_contacted = TRUE;

-- Get tool usage stats
SELECT 
    t.name,
    COUNT(*) as total_calls,
    SUM(tu.credits_used) as total_credits,
    AVG(tu.duration_ms) as avg_duration
FROM tool_usage tu
JOIN tools t ON tu.tool_id = t.id
WHERE tu.created_at >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY t.name;
```

---

## Queue + Global Tracking Additions

These tables and views power the send queue, global 60-day rule, and visual dashboards.

### Message Templates (Optional but recommended)
```sql
CREATE TABLE message_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    offer_id UUID NOT NULL REFERENCES offers(id) ON DELETE CASCADE,
    campaign_id UUID REFERENCES campaigns(id) ON DELETE SET NULL,
    name TEXT NOT NULL,
    channel TEXT NOT NULL CHECK (channel IN ('email', 'linkedin_connect', 'linkedin_dm', 'linkedin_inmail')),
    sequence_step INTEGER,
    template_key TEXT,
    subject TEXT,
    body TEXT NOT NULL,
    status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'approved', 'archived')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Send Queue (Scheduled Messages)
```sql
CREATE TABLE send_queue (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
    campaign_contact_id UUID REFERENCES campaign_contacts(id),
    contact_id UUID NOT NULL REFERENCES contacts(id),
    account_id UUID REFERENCES accounts(id),
    channel TEXT NOT NULL CHECK (channel IN ('email', 'linkedin_connect', 'linkedin_dm', 'linkedin_inmail')),
    sequence_step INTEGER,
    subject TEXT,
    body TEXT NOT NULL,
    scheduled_for TIMESTAMPTZ NOT NULL,
    priority INTEGER DEFAULT 5 CHECK (priority BETWEEN 1 AND 10),
    status TEXT DEFAULT 'pending' CHECK (status IN (
        'pending', 'scheduled', 'processing', 'sent', 'delivered',
        'failed', 'bounced', 'cancelled', 'skipped'
    )),
    attempts INTEGER DEFAULT 0,
    max_attempts INTEGER DEFAULT 3,
    last_attempt_at TIMESTAMPTZ,
    last_error TEXT,
    external_message_id TEXT,
    sent_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Note:** `send_queue` is the execution queue used by Railway cron.  
If a message is only in `messages`, it will **not** send until it is enqueued.

### Message Events (Detailed Outcomes)
```sql
CREATE TABLE message_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    send_queue_id UUID NOT NULL REFERENCES send_queue(id) ON DELETE CASCADE,
    contact_id UUID NOT NULL REFERENCES contacts(id),
    campaign_id UUID NOT NULL REFERENCES campaigns(id),
    account_id UUID REFERENCES accounts(id),
    event_type TEXT NOT NULL CHECK (event_type IN (
        'queued', 'scheduled', 'sent', 'delivered', 'opened', 'clicked',
        'replied', 'bounced', 'spam', 'unsubscribed', 'failed', 'skipped'
    )),
    event_data JSONB DEFAULT '{}',
    reply_text TEXT,
    reply_sentiment TEXT CHECK (reply_sentiment IN (
        'positive', 'negative', 'neutral', 'question', 'ooo'
    )),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Outreach History (Global 60-Day Rule)
```sql
CREATE TABLE outreach_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contact_email TEXT,
    contact_linkedin_url TEXT,
    contact_id UUID REFERENCES contacts(id),
    campaign_id UUID REFERENCES campaigns(id),
    offer_id UUID REFERENCES offers(id),
    account_id UUID REFERENCES accounts(id),
    send_queue_id UUID REFERENCES send_queue(id) ON DELETE SET NULL,
    channel TEXT NOT NULL CHECK (channel IN ('email', 'linkedin_connect', 'linkedin_dm', 'linkedin_inmail')),
    message_subject TEXT,
    message_body TEXT,
    sent_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    status TEXT DEFAULT 'sent' CHECK (status IN ('sent', 'delivered', 'bounced', 'replied', 'spam', 'failed')),
    replied_at TIMESTAMPTZ,
    reply_sentiment TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Pipeline Tracking (Multi-Step Runner)
```sql
CREATE TABLE pipeline_runs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    offer_id UUID REFERENCES offers(id),
    campaign_id UUID REFERENCES campaigns(id),
    steps JSONB NOT NULL,
    input_params JSONB DEFAULT '{}',
    status TEXT DEFAULT 'running' CHECK (status IN ('running', 'completed', 'failed', 'cancelled')),
    error_message TEXT,
    output_summary JSONB DEFAULT '{}',
    started_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

CREATE TABLE pipeline_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pipeline_run_id UUID NOT NULL REFERENCES pipeline_runs(id) ON DELETE CASCADE,
    step_name TEXT NOT NULL,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'running', 'completed', 'failed', 'skipped')),
    step_output JSONB DEFAULT '{}',
    error_message TEXT,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ
);
```

### Views for the Dashboard
```sql
-- Clay-style leads table
CREATE VIEW leads_for_review AS
SELECT
    c.id as contact_id,
    c.first_name,
    c.last_name,
    c.full_name,
    c.email,
    c.email_status,
    c.email_verified,
    c.email_verification_source,
    c.linkedin_url,
    c.title,
    c.connection_degree,
    c.global_status,
    c.global_last_contacted_at,
    c.global_contact_count,
    c.eligible_for_outreach,
    co.id as company_id,
    co.name as company_name,
    co.domain,
    co.size,
    co.industry,
    co.signals,
    co.fit_score,
    co.priority as company_priority,
    co.source_tool,
    cc.id as campaign_contact_id,
    cc.status as campaign_status,
    cc.current_step,
    camp.id as campaign_id,
    camp.name as campaign_name,
    camp.campaign_type,
    sq.id as queue_id,
    sq.scheduled_for,
    sq.status as queue_status,
    sq.channel,
    a.name as sending_account,
    a.health_score as account_health
FROM contacts c
JOIN companies co ON c.company_id = co.id
LEFT JOIN campaign_contacts cc ON cc.contact_id = c.id
LEFT JOIN campaigns camp ON cc.campaign_id = camp.id
LEFT JOIN send_queue sq ON sq.contact_id = c.id AND sq.status IN ('pending', 'scheduled')
LEFT JOIN accounts a ON sq.account_id = a.id;

-- Today's schedule
CREATE VIEW todays_schedule AS
SELECT
    sq.*,
    c.full_name as contact_name,
    c.email as contact_email,
    co.name as company_name,
    camp.name as campaign_name,
    a.name as account_name,
    a.health_score
FROM send_queue sq
JOIN contacts c ON sq.contact_id = c.id
JOIN companies co ON c.company_id = co.id
JOIN campaigns camp ON sq.campaign_id = camp.id
LEFT JOIN accounts a ON sq.account_id = a.id
WHERE sq.scheduled_for::date = CURRENT_DATE
AND sq.status IN ('pending', 'scheduled')
ORDER BY sq.scheduled_for ASC;

-- Account capacity
CREATE VIEW account_capacity AS
SELECT
    a.id,
    a.name,
    a.type,
    a.health_score,
    a.status,
    a.daily_limit_emails,
    a.daily_limit_connections,
    a.daily_limit_messages,
    COALESCE(a.today_emails, 0) as today_emails,
    COALESCE(a.today_connections, 0) as today_connections,
    COALESCE(a.today_messages, 0) as today_messages,
    a.daily_limit_emails - COALESCE(a.today_emails, 0) as emails_remaining,
    a.daily_limit_connections - COALESCE(a.today_connections, 0) as connections_remaining,
    a.daily_limit_messages - COALESCE(a.today_messages, 0) as messages_remaining,
    CASE
        WHEN a.status != 'active' THEN FALSE
        WHEN COALESCE(a.health_score, 100) < 30 THEN FALSE
        WHEN a.type = 'email' AND COALESCE(a.today_emails, 0) >= a.daily_limit_emails THEN FALSE
        WHEN a.type = 'linkedin' AND COALESCE(a.today_connections, 0) >= a.daily_limit_connections THEN FALSE
        ELSE TRUE
    END as can_send_now
FROM accounts a;

-- Unified activity feed (scheduled + sent)
CREATE VIEW activity_feed AS
SELECT
    'scheduled' as activity_type,
    sq.id as item_id,
    sq.scheduled_for as occurred_at,
    sq.status,
    sq.channel,
    c.full_name as contact_name,
    c.email as contact_email,
    c.linkedin_url as contact_linkedin_url,
    co.name as company_name,
    camp.name as campaign_name,
    a.name as account_name
FROM send_queue sq
LEFT JOIN contacts c ON sq.contact_id = c.id
LEFT JOIN companies co ON c.company_id = co.id
LEFT JOIN campaigns camp ON sq.campaign_id = camp.id
LEFT JOIN accounts a ON sq.account_id = a.id

UNION ALL

SELECT
    'sent' as activity_type,
    oh.id as item_id,
    oh.sent_at as occurred_at,
    oh.status,
    oh.channel,
    c.full_name as contact_name,
    COALESCE(oh.contact_email, c.email) as contact_email,
    COALESCE(oh.contact_linkedin_url, c.linkedin_url) as contact_linkedin_url,
    co.name as company_name,
    camp.name as campaign_name,
    a.name as account_name
FROM outreach_history oh
LEFT JOIN contacts c ON oh.contact_id = c.id
LEFT JOIN companies co ON c.company_id = co.id
LEFT JOIN campaigns camp ON oh.campaign_id = camp.id
LEFT JOIN accounts a ON oh.account_id = a.id;
```

### Daily Volume per Account (Emails)
```sql
CREATE OR REPLACE VIEW daily_account_message_volume AS
SELECT
  a.id AS account_id,
  a.name AS account_name,
  date_trunc('day', m.scheduled_at) AS day,
  COUNT(*) FILTER (WHERE m.scheduled_at IS NOT NULL) AS scheduled,
  COUNT(*) FILTER (WHERE m.status = 'pending') AS pending,
  COUNT(*) FILTER (WHERE m.status IN ('sent','delivered','opened','clicked','replied','meeting')) AS sent,
  COUNT(*) FILTER (WHERE m.status IN ('failed','bounced')) AS errored
FROM messages m
JOIN accounts a ON a.id = m.account_id
GROUP BY a.id, a.name, date_trunc('day', m.scheduled_at);
```
